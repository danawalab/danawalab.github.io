---
layout: post
title:  "1G λ©”λ¨λ¦¬λ¥Ό μ‚¬μ©ν•μ—¬ 1μ΄λ§μ— 2TB ν…μ¤νΈνμΌμ„ κ²€μƒ‰ν•κΈ°"
description: "λ””μ¤ν¬ κΈ°λ° μ •λ ¬μ„ ν†µν•΄ λ€μ©λ‰ ν…μ¤νΈ νμΌμ λ‚΄μ©μ„ κ²€μƒ‰ν•μ—¬ APIλ΅ μ κ³µν•λ” λ°©λ²•"
date:   2022.07.22.
writer: "λ°μ¤μ„±"
categories: Elastic
---

## λ€μ©λ‰ νμΌμ„ λ¨λ‘ λ’¤μ Έμ„ κ²€μƒ‰ν•  λ• λ¬Έμ μ 

μ—…λ¬΄λ¥Ό ν•λ‹¤λ³΄λ©΄ λ€μ©λ‰ νμΌ(Gb, Tb λ‹¨μ„)μ„ λ‹¤λ£° μΌμ΄ μΆ…μΆ… μμµλ‹λ‹¤. 

λ³΄ν†µ μμ‹ μ΄ μ£Όλ΅ μ‚¬μ©ν•λ” ``Notepad++``λ‚ ``Vim``κ³Ό κ°™μ€ λ¬Έμ„ νΈμ§‘ λ„κµ¬λ¥Ό μ΄μ©ν•΄ ν° νμΌλ“¤μ„ λ¶λ¬μ™€μ„ λ‚΄μ©μ„ νƒμƒ‰ν•κ³¤ ν•©λ‹λ‹¤.

μ‘μ€ νμΌμ΄λΌλ©΄ μμ‹κ°„μ— μ½μ–΄μ„ μ›ν•λ” λ‚΄μ©μ„ κ²€μƒ‰ν•  μ μμ§€λ§ ν° νμΌμ„ λΉλ²ν•κ² μ½μ–΄μ•Όν•  μΌμ΄ μƒκΈ΄λ‹¤λ©΄ κ·Έλ•λ§λ‹¤ νμΌμ„ μ—΄μ–΄ νƒμƒ‰ν•κΈ°κΉμ§€ κΈ°λ‚κΈ΄ μΈκ³ μ μ‹κ°„ (π™‰) μ„ λ³΄λ‚΄μ•Ό ν•  μ§€ λ¨λ¦…λ‹λ‹¤.


![/images/2022-11-10-big-file-searcher/error.png](/images/2022-11-10-big-file-searcher/error.png)
<div>
  μ•„λ¬΄λλ„ λ…ΈνΈν¨λ“κ°€ κ°λ‹Ήν•κΈ°μ—” λ¬΄λ¦¬.
</div>
<br>

## μ–΄λ–»κ² ν•λ©΄ μ‰½κ³  λΉ λ¥΄κ² νμΌμ„ μ—΄μ–΄ κ²€μƒ‰ν•  μ μμ„κΉ?

#### 1. μƒ‰μΈμ κ°λ…

μ°λ¦¬κ°€ μ‚¬μ „μ—μ„ μ›ν•λ” λ‚΄μ©μ„ μ°Ύλ”λ‹¤λ©΄, λ³΄ν†µ λ§¨ λ’· νμ΄μ§€μ— μλ” ``μƒ‰μΈ``λ¶€ν„° μ‚΄ν΄λ΄…λ‹λ‹¤. κΈ°νΈμ™€ ν™μλ΅ μ •λ ¬λ μΌλ ¨μ λ©λ΅μ—μ„ νΉμ • μ„μΉλ¥Ό κΈ°λ΅ν•κ³  μκΈ°μ— μ„μΉλ¥Ό κΈ°μ¤€μΌλ΅ κ²€μƒ‰ν•©λ‹λ‹¤. μ΄λ ‡κΈ°μ— λ§¨ μ²«μ¥λ¶€ν„° μ›ν•λ” λ‹¨μ–΄κ°€ λ‚μ¬ λ•κΉμ§€ κ²€μƒ‰ν•λ” λΉ„μ©μ„ μ•„λ‚„ μ μμµλ‹λ‹¤.

κΈ°λ³Έμ μΌλ΅ μ»΄ν“¨ν„°μ—μ„ μ²μ ν° νμΌμ„ μ—΄λ•λ” μ²« μ¤„λ¶€ν„° λ§μ§€λ§‰ μ¤„κΉμ§€ μ½μ–΄λ‚΄λ¦½λ‹λ‹¤. ν•μ§€λ§ λ‚΄κ°€ μ°Ύλ” ν‚¤μ›λ“μ μ„μΉλ¥Ό μ•κ³  μλ‹¤λ©΄, ν•΄λ‹Ή ν¬μ§€μ…λ¶€ν„° μ½μ„ μ μμµλ‹λ‹¤. λ‹¨ μƒ‰μΈπ“–μ΄ μ΅΄μ¬ν•΄μ•Όκ² μ§€λ§μ”.

#### 2. μƒ‰μΈ νμΌ λ§λ“¤κΈ°

μƒ‰μΈμ΄ ν•„μ”ν•λ‹¤λ” μ‚¬μ‹¤μ„ μ•μ•μΌλ‹ κ·Έ λ°©λ²•μ„ μ‚΄ν΄λ³΄κ² μµλ‹λ‹¤. μ°μ„  ν° νμΌμ„ μ—΄μ–΄ μ°Ύκ³ μ ν•λ” λ‹¨μ–΄μ
μ„μΉλ¥Ό κΈ°λ΅ν•©λ‹λ‹¤. μ΄ μ„μΉλ¥Ό λ©”λ¨λ¦¬μ— λ°”λ΅ μ¬λ¦¬λ©΄ νΈν•κ² μ§€λ§ κ·Έλ ‡κ² λλ©΄ λΉ„μ‹Έκ³  ν° λ©”λ¨λ¦¬λ¥Ό ν•„μ”λ΅ ν•©λ‹λ‹¤.

μ΄λ΄λ•λ” λ””μ¤ν¬μ λ…Έλ” κ³µκ°„μ„ μ΅°κΈ ν™μ©ν•©λ‹λ‹¤. μ°Ύκ³ μν•λ” ν‚¤μ›λ“μ™€ μ„μΉκ°€ κΈ°λ΅λ μΈλ±μ¤ νμΌμ„ μ‘μ„±ν•΄ μ €μ¥ν•λ” κ²ƒμ΄μ§€μ”. μλ΅λ“¤λ©΄ <μƒν’ID>,<λ°”μ΄νΈ μ>λ¥Ό κΈ°λ΅ν•΄λ†“μ•λ‹¤κ°€ κ²€μƒ‰ν• λ• μ΄ νμΌμ„ μ°Έμ΅°ν•΄μ„ μ›λ³Έ λ‚΄μ©μ—μ„ ν•„μ”ν• λ§νΌ μ½μ–΄λ‚΄λ” μ‹μ…λ‹λ‹¤.

λ‹¤λ§ νμΌμ λ‚΄μ©μ΄ μ •λ ¬λ λ°μ΄ν„°λΌλ” λ³΄μ¥μ΄ μ—†μΌλ―€λ΅ μ†ν…μ΄ ν•„μ”ν•©λ‹λ‹¤. μ—¬κΈ°μ„ λ©”λ¨λ¦¬μ— λ‹¨μ„ ν¬κΈ° λ§νΌ μ¬λ ¤ ν€µ μ†νΈλ¥Ό ν†µν•΄ λ¶€λ¶„μ μΌλ΅ μ •λ ¬μ„ μ‹λ„ν•©λ‹λ‹¤. μ•½ 10,000,000 λΌμΈμ νμΌμ΄ μμ„λ• 1,000κ±΄, 2,000κ±΄, 4,000κ±΄, 8,000κ±΄, ... , 10,000,000κ±΄κΉμ§€ μ²­ν¬ νμΌμ„ λ§λ“¤μ–΄ λ””μ¤ν¬ κΈ°λ° μ •λ ¬μ„ μ‹λ„ν•©λ‹λ‹¤.

```go
// μ•„μ£Ό κ°„λ‹¨ν• ν€µ μ†νΈ μ•κ³ λ¦¬μ¦, μ‹¤ν¨μ‹ μµμΆ… μ„μΉλ¥Ό λ°ν™ν•λ‹¤
func QuickSortList(a []model.Index) []model.Index {

	if len(a) < 2 {
		return a
	}

	left, right := 0, len(a)-1

	pivot := rand.Int() % len(a)

	a[pivot], a[right] = a[right], a[pivot]

	for i, _ := range a {
		if a[i].ProductId < a[right].ProductId {
			a[left], a[i] = a[i], a[left]
			left++
		}
	}

	a[left], a[right] = a[right], a[left]

	QuickSortList(a[:left])
	QuickSortList(a[left+1:])

	return a

}
```


μ΄λ ‡κ² λ§λ“¤μ–΄μ§„ μƒ‰μΈ νμΌμ„ λ©”λ¨λ¦¬μ— κ³§λ°”λ΅ μ¬λ ¤λ„ λμ§€λ§, λ©”λ¨λ¦¬ ν¬κΈ°μ— λ”°λΌ μ–΄λ–¤ PCμ—μ„λ” λ™μ‘ν•κ³  λ λ‹¤λ¥Έ PCμ—μ„λ” λ™μ‘ν•μ§€ μ•μ„ μ μμµλ‹λ‹¤. κ·Έλμ„ μΈλ±μ¤μ 1/Nλ§ κ°€μ§€κ³  μλ” μƒ‰μΈ νμΌμ„ λ‹¤μ‹ μƒ‰μΈν•©λ‹λ‹¤.

μµμΆ…μ μΌλ΅ μ°λ¦¬κ°€ λ©”λ¨λ¦¬μ— μ μ¬ν•μ—¬ κ²€μƒ‰μ— μ‚¬μ©ν•  λ‚΄μ©μ€ μΈλ±μ¤ νμΌμ μΈλ±μ¤ νμΌμ΄ λλ” μ…μ…λ‹λ‹¤.

![/images/2022-11-10-big-file-searcher/index_0.png](/images/2022-11-10-big-file-searcher/index_0.png)

![/images/2022-11-10-big-file-searcher/index_6.png](/images/2022-11-10-big-file-searcher/index_6.png)
<div>
  μ›λ³Έ μƒν’ λ°μ΄ν„° νμΌ (λ¬΄λ ¤ 60GB)
</div>

![/images/2022-11-10-big-file-searcher/index_1.png](/images/2022-11-10-big-file-searcher/index_4.png)
<div>
  μƒν’ μ•„μ΄λ”” κΈ°μ¤€μΌλ΅ μƒ‰μΈν•λ‹¤
</div>

![/images/2022-11-10-big-file-searcher/index_1.png](/images/2022-11-10-big-file-searcher/index_5.png)
<div>
  μµμΆ…μ μΌλ΅ λ©”λ¨λ¦¬μ— μ¬λ¦΄ νμΌ, μƒ‰μΈ νμΌμ„ ν•λ² λ” μƒ‰μΈν•λ‹¤
</div>
<br>

#### 3. κ²€μƒ‰ν•κΈ°

μΈλ±μ¤ νμΌμ—μ„ λ‚μ¨ κ²½λ‰ν™” μΈλ±μ¤ νμΌμ€ μ‰½κ² λ§ν•΄ κ°„κ²©μ΄ λ„μ›μ§„ μƒ‰μΈ νμΌμ…λ‹λ‹¤. μ΄λ ‡κ² μ™„μ „ν• μƒ‰μΈ νμΌμ΄ μ•„λ‹λ°λ„ κ²€μƒ‰ν•  μ μλ” λ°©λ²•μ΄ μμµλ‹λ‹¤. λ°”λ΅ μ΄μ§„ νƒμƒ‰(binary search)λ¥Ό ν†µν•΄ κ²€μƒ‰μ„ μ§„ν–‰ν•κ³  μ‹¤ν¨ν• λ¶€λ¶„μ—μ„λ” μ›λ μΈλ±μ¤ νμΌλ΅ λμ•„κ°€ κ°„κ²©λ§νΌ μ½μ–΄λ‚΄λ” λ°©μ‹μ…λ‹λ‹¤.

μ¦‰, 1,000κ°μ”© λ„μ›μ§„ μƒ‰μΈ νμΌμ΄ μμ„λ• μ‹¤ν¨ν• μ§€μ μ—μ„ 1,000κ° λ§νΌ μ½μ–΄λ‚΄λ©΄ κ°„κ²©μ‚¬μ΄μ λ°μ΄ν„°λ¥Ό μ°Ύμ„ μ μμµλ‹λ‹¤. μ΄λ¥Ό ν†µν•΄ μ „μ²΄κ°€ μ•„λ‹ λ¶€λ¶„μ μΌλ΅ νƒμƒ‰ν•λ―€λ΅ μ μ€ μμ›μΌλ΅ __λΉ λ¥Έ__ κ²€μƒ‰μ΄ κ°€λ¥ν•©λ‹λ‹¤.  β΅

```go
// μ•„μ£Ό κ°„λ‹¨ν• λ°”μ΄λ„λ¦¬ μ„μΉ μ•κ³ λ¦¬μ¦
func BinarySearch(array []model.MiniIndex, target string) (int, bool) {
	var isExist bool

	r := -1 // not found
	start := 0
	end := len(array) - 1
	for start <= end {
		mid := (start + end) / 2
		if array[mid].ProductId == target {
			r = mid // found
			break
		} else if array[mid].ProductId < target {
			start = mid + 1
		} else if array[mid].ProductId > target {
			end = mid - 1
		}
	}

	if r == -1 {
		if end == -1 {
			r = 0
		} else {
			// μ—†μ„ κ²½μ° μµμΆ…μ μΌλ΅ μ½μ€ λ¶€λ¶„μ„ λ¦¬ν„΄ν•λ‹¤
			r = end
		}
	} else {
		isExist = true
	}

	// μ°Ύμ€ μΈλ±μ¤λ¥Ό λ¦¬ν„΄ν•λ‹¤
	return r, isExist
}
```


![/images/2022-11-10-big-file-searcher/search_0.png](/images/2022-11-10-big-file-searcher/search_0.png)
<br>

## νμΌ μ„μ² μ„λΉ„μ¤
![/images/2022-11-10-big-file-searcher/service_0.png](/images/2022-11-10-big-file-searcher/service_0.png)

ν„μ¬ μ„λΉ„μ¤ μ¤‘μΈ νμΌ μ„μ²μ κµ¬μ΅°λ” λ‹¤μκ³Ό κ°™μµλ‹λ‹¤. μμ§‘λ μƒν’ λ°μ΄ν„°μ— λ€ν•΄ λ””λ ‰ν† λ¦¬ κ°μ§€λ¥Ό ν†µν•΄ ν•΄λ‹Ή νμΌμ— λ€ν•΄ μƒ‰μΈν•μ—¬ λ©”λ¨λ¦¬μ— μ μ¬ν•©λ‹λ‹¤. κ²€μƒ‰ APIλ¥Ό ν†µν•΄ μ”μ²­μ΄ λ“¤μ–΄μ¤λ©΄, μƒ‰μΈλ λ‚΄μ©μ„ κΈ°λ°μΌλ΅ νƒμƒ‰ν•κ³  μ”μ²­λ λ°μ΄ν„°λ¥Ό λ°ν™ν•©λ‹λ‹¤.

λ°μ΄ν„°λ” μ„¤μ •μ„ ν†µν•΄ νμ‹±ν•λ” λ°©μ‹, μƒ‰μΈ κ°„κ²©, μ μ¬ λ°μ΄ν„° μ΄κΈ°ν™” μ¤μΌ€μ¤„λ“±μ„ μ„¤μ •ν•  μ μμΌλ©° Go 1.18μ„ μ‚¬μ©ν•΄ κ°λ°λμ—μµλ‹λ‹¤.

## νμΌ μ„μ² μ„λΉ„μ¤ API κ°€μ΄λ“

`GET /search`

ν•΄λ‹Ή μ—…μ²΄ μ½”λ“μ™€ μƒν’IDλ΅ μ›λ³Έ νμΌμ λ‚΄μ©μ„ μ΅°νν•©λ‹λ‹¤.

#### Request Parameter
|parameter|description|data type|example value
|:---:|:---:|:---:|:---:|
|shopCode|μ—…μ²΄ μ½”λ“|string|TH201, ED302 , ..|
|productId|μƒν’ μ•„μ΄λ””|string|2074042,7658077,2186943|
|startDate|λ‚ μ§ From|string (YYYYMMDD)|20221110|
|endDate|λ‚ μ§ To|string (YYYYMMDD)|20221111|
|renew|μ „μ²΄/κ°±μ‹  μ—¬λ¶€|string||

#### Return Value
- result : κ²€μƒ‰ μ²λ¦¬ κ²°κ³Ό (success or fail)
- date : κ²€μƒ‰ μΌμ
- renew : μ „μ²΄/κ°±μ‹  μ—¬λ¶€
- data : κ²€μƒ‰ λ‚΄μ©
- timestamp : ν•΄λ‹Ή λ°μ΄ν„° μΌμ
- source : μ›λ³Έ λ°μ΄ν„° λ‚΄μ©


```
GET /search?shopCode=EE301&productId=2073143136&startDate=20220326&&endDate=20220329

    {
        result: success,
        date: 20220926,
        renew : 1,
        data : [
            {
                timestamp: 1664171131
                source :    "2073143136^μ΄λ―Έμ©|ν™”μ¥ν’|λ©”μ΄ν¬μ—…(μ—¬μ„±μ©)|λ³Όν„°μΉ/ν•μ΄λΌμ΄ν„°^[ν„λ€λ°±ν™”μ ] [μ‚Όμ„±μΉ΄λ“7%ν• μΈ~08/22]μ•„μ›κΈ€λμ¤ μ•°λΉ„μ–ΈνΈ λΈ”λ¬μ‰¬ +λ¬΄μ΄μ3κ°μ›”^(μ£Ό) μ‹ μ„Έκ³„μΈν„°λ„¤μ…”λ‚ ^http://image.thehyundai.com/static/3/1/3/14/73/2073143136_0_600.jpg^http://www.thehyundai.com/front/pda/itemPtc.thd?       
                         ReferCode=030&utm_source=danawa&utm_medium=ep_price&slitmCd=2073143136^60000^0^^0κ°μ›”^^^^^0^μ‚Όμ„±μΉ΄λ“^55800^^60000^N^^N^Y"
            },
            {
                timestamp : 1661929118
                source :    "2073143136^μ΄λ―Έμ©|ν™”μ¥ν’|λ©”μ΄ν¬μ—…(μ—¬μ„±μ©)|λ³Όν„°μΉ/ν•μ΄λΌμ΄ν„°^[ν„λ€λ°±ν™”μ ] [μ‚Όμ„±μΉ΄λ“7%ν• μΈ~08/22]μ•„μ›κΈ€λμ¤ μ•°λΉ„μ–ΈνΈ λΈ”λ¬μ‰¬ +λ¬΄μ΄μ3κ°μ›”^(μ£Ό) μ‹ μ„Έκ³„μΈν„°λ„¤μ…”λ‚ ^http://image.thehyundai.com/static/3/1/3/14/73/2073143136_0_600.jpg^http://www.thehyundai.com/front/pda/itemPtc.thd?       
                         ReferCode=030&utm_source=danawa&utm_medium=ep_price&slitmCd=2073143136^60000^0^^0κ°μ›”^^^^^0^μ‚Όμ„±μΉ΄λ“^45800^^50000^N^^N^Y"
            }
        ]
    },
    {
        result : success,
        date : 20220925,
        renew : 1,
        data : [
            {
                timestamp : 1664171131
                source :    "2073143136^μ΄λ―Έμ©|ν™”μ¥ν’|λ©”μ΄ν¬μ—…(μ—¬μ„±μ©)|λ³Όν„°μΉ/ν•μ΄λΌμ΄ν„°^[ν„λ€λ°±ν™”μ ] [μ‚Όμ„±μΉ΄λ“7%ν• μΈ~08/22]μ•„μ›κΈ€λμ¤ μ•°λΉ„μ–ΈνΈ λΈ”λ¬μ‰¬ +λ¬΄μ΄μ3κ°μ›”^(μ£Ό) μ‹ μ„Έκ³„μΈν„°λ„¤μ…”λ‚ ^http://image.thehyundai.com/static/3/1/3/14/73/2073143136_0_600.jpg^http://www.thehyundai.com/front/pda/itemPtc.thd?       
                         ReferCode=030&utm_source=danawa&utm_medium=ep_price&slitmCd=2073143136^60000^0^^0κ°μ›”^^^^^0^μ‚Όμ„±μΉ΄λ“^55800^^60000^N^^N^Y"
            },
            {
                timestamp : 1661929118
                source :    "2073143136^μ΄λ―Έμ©|ν™”μ¥ν’|λ©”μ΄ν¬μ—…(μ—¬μ„±μ©)|λ³Όν„°μΉ/ν•μ΄λΌμ΄ν„°^[ν„λ€λ°±ν™”μ ] [μ‚Όμ„±μΉ΄λ“7%ν• μΈ~08/22]μ•„μ›κΈ€λμ¤ μ•°λΉ„μ–ΈνΈ λΈ”λ¬μ‰¬ +λ¬΄μ΄μ3κ°μ›”^(μ£Ό) μ‹ μ„Έκ³„μΈν„°λ„¤μ…”λ‚ ^http://image.thehyundai.com/static/3/1/3/14/73/2073143136_0_600.jpg^http://www.thehyundai.com/front/pda/itemPtc.thd?       
                         ReferCode=030&utm_source=danawa&utm_medium=ep_price&slitmCd=2073143136^60000^0^^0κ°μ›”^^^^^0^μ‚Όμ„±μΉ΄λ“^45800^^50000^N^^N^Y"
            }
        ]
    }
```

## νμΌ μ„μ² μ„λΉ„μ¤ μ„±λ¥

|μ„λ²„|μμ§‘λ EP νμΌ ν¬κΈ°|μ‹¤ λ©”λ¨λ¦¬ μ‚¬μ©λ‰|μ›λ³Έ λ€λΉ„ μƒ‰μΈ ν¨μ¨|κ²€μƒ‰ μ†λ„
|:---:|:---:|:---:|:---:|:---:|
|server1|607G|296M|0.048%|0.959μ΄
|server2|757G|431M|0.056%|1.003μ΄
|server3|569G|419M|0.073%|0.8μ΄
|Total|1.9TB|1,029M|0.059%(ν‰κ· )|0.9μ΄(ν‰κ· )

μƒ‰μΈν™” κ³Όμ •μ„ ν†µν•΄ μ›λ³ΈEP νμΌμ μΈλ±μ¤ νμΌμ„ λ©”λ¨λ¦¬μ— μ¬λ ¤μ„ μ‚¬μ©ν•κ³  μμΌλ©°, μ›λ³Έ νμΌ λ€λΉ„ μ•½ 0.05%μ μƒ‰μΈ ν¨μ¨μ„ λ³΄μ΄κ³  μμµλ‹λ‹¤.

μ•½ __2T__ λ°μ΄ν„°μ— λ€ν•΄ κ²€μƒ‰ μ†λ„λ” ν‰κ·  __1μ΄__ μ΄ν•μ κ²€μƒ‰κ²°κ³Όλ¥Ό μ κ³µν•κ³  μμµλ‹λ‹¤.

## μ •λ¦¬
ν° νμΌμ„ μ½λ”κ²ƒμ€ μμ›κ³Ό μ‹κ°„μ΄ λ§μ΄ μ†μ”λλ” μΌμ΄λ―€λ΅ κ°€λ¥ν• νμΌ μ„μ²μ™€ κ°™μ€ κ²€μƒ‰ λ„κµ¬λ¥Ό ν™μ©ν•μ—¬ κ²€μƒ‰ν•λ” κ²ƒμ΄ λ°”λμ§ν•λ‹¤κ³  μƒκ°λ©λ‹λ‹¤. λν• κ°λ° ν›„ ν…μ¤νΈλ¥Ό ν†µν•΄ λ°μ΄ν„° κ²€μ¦μ„ λ§μ³¤μΌλ―€λ΅ λ‹¤μ–‘ν• λ¬Έμ„ ν¬λ§·μ— λ€ν•΄ μƒ‰μΈ/κ²€μƒ‰ κ°€λ¥ μ—¬λ¶€λ¥Ό ν™•μΈν•λ” κ²ƒμ΄ μ¤‘μ”ν•λ‹¤κ³  μƒκ°ν•©λ‹λ‹¤.

Github link :  https://github.com/danawalab/left-join-plugin

## μ°Έκ³  μλ£
- https://www.elastic.co/guide/en/elasticsearch/reference/current/docs-reindex.html